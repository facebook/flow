language: c
sudo: false

os:
- linux
- osx

env:
  matrix:
  - OCAML_VERSION=4.02.1 OPAM_VERSION=1.2.0
  - OCAML_VERSION=4.02.1 OPAM_VERSION=1.1.1
  - OCAML_VERSION=4.01.0 OPAM_VERSION=1.2.0
  - OCAML_VERSION=4.01.0 OPAM_VERSION=1.1.1
  global:
  # GH_BOT_TOKEN (facebook-github-bot-0)
  - secure: I1W8xlf8Ojxkc92n8Rb9AGX7kdCk0DeWEPd6PKRrGQO0FtyCkcvxNo+wp6ApQI7+NqkuFRVngHVOQOd3AqR57IFiSjZ+Cj/BJyg6WOo92olkAAP0OWihmCj53d2xDpp7LaM99srPbZXYE5vSTTKBX/5Soz9UghzsI5Q1ECmV5fU=
  # S3_ID
  - secure: Phw7imLAqDsb+fK8Qbnlz45jCOMr+kt7S7JitRpNsQfwyfLrUST1SJLrf4xDniJ60A7UjMTqUfauuF6cVM4jX7oEHfp2tjjKKJJQTOlU5Z0BhP/rjWxHHccLwgzB6LVezPZu2hhlmKHdSSGizXAyuvFsEhuea96E33mrnu5AT0Ps754maJ5OTZrEfJnlkLYXXvfLvmh69/+6kdS3lTkUH9F/iKaFxslelzzqDlxF/yJueEKX7EvjzRcP8zOezPntu804pER02rc1xo4tg91v1xTnyxqpkehUmTox4EhhQORAD7plQZ3E5UNlIrLMZZbRu+zYHfrIaRWsi9jbULn5oJKnbX7x0cWY7D4AlRMG4QOyZCOGk/6YFBJafZ1bXwkOrgNWtRJwEJQNS92Drs6YG4zzcKw7ZBwgnIBVS/nnQrELvE2qDJeJZubcpMSPnSz9uEyLVjEemAEAckxyRQt9hbQk9Tzo8EUX4E2foXfUcMdiiyLrMYKhSRgHFt5frYREdtsKyrLvZK9QVAsMnFtytV6ne7xorTdQ45Jdgpbg5MbWqK8ifAllKhm94eJxlN7Mq1pGaRnXUtGS+yjl/fgOePtpwAsTS1+ASn/V9Sey2mt3xq1DL5TFVFpakUU7kQGT6oc8Kj1Qkt5Tk6KPQUtCm3eyH5Oxz5M5knOV91dTzT4=
  # S3_SECRET
  - secure: Kjfwl1Lk6zaVxwGOyy19byxRU44QbGZAE88ikLaKNtdbR7h5SHjdJgcIhp0xqK5kn0zk0U4mzAPIkKMQd7jrOkJEOpYWbD7KpNInlezviWBvpqXNlxLMGF62IXgPKrgHOhDT0Bc64OBjgbLV4YBht6pNu5miCJM6PPSTvGAXbY4eo6avb5SwWm7whTVD1C7llM7U9vzwHpToZ1KGAUTdlIpvUyYyFsPpfV3eL8Z8NQOD4wJU9AWv2ljEnX9W1A66gHmGn9hIRprdReYGTviF63MSXYEhRZ32+22EPhViQsd0p3go0UotS9vGzOYCNq9W+JGcKyB8Nkab8jDot7ASCsaNrzA1I+/tq4qP83dnfev4iZZUr7kIpsK7xZ++5kHktYrIwsNtwW1yuwTvdyGl3y+/YMGh9wLP0C/77uZdPB18A6Tgl/iNLmcUPJW2q4dVsWb9+5yUS+MtlFLS1QZETO81HsjJSDnztdu1gDkaJPwW+Axn0grjT1se+ZaouTe9XzOI1DWa8h89zt5q3JwrioFbr05iISdysu3i4/ioDTrFIYYQni+mv0+97fMh20KA2Xf4D2/As6W5Rzm8PgFP2Bq+jHa2lsFjOD/MUfo+D+9VS4UiWhxqD7R3XFTth6jS6xKT5UhpN7fzfQ72qdGIZfO4G4uzP2nbm0Qxf+9Sv88=
  # CLOUDFRONT_ID
  - secure: FWfQ08mdSkew9L2RtTGulI4eQo2NlW/78a7QSp6Zch4mpDYHHOB46oBtBTRaV8zCjJfV6IYeNbCAjSfivZC52rXSjz89PdA6cUgFNwa7DgfVqjGjJArcnQFk9YLSaRvBIGSFTHDHTVVjEPd9q79e/lBvbPRhaf1m41ilvMRkb+WDRBuG8U3t3tJfao8eFCMEvA3feuPgr7HQQjq0emI7Oa5tGq0boCTDoKhNQJK5Uqi/uD4Uv1x9cQLS5iZajfMqna4m9CO7csBTTKkElT9gPvRKoATfmd9cNo0xKnESC0mAcCMMlqqTBXbFsNKIi0NcbYqISikNDK1Ciw05Qn2XFuqqnZK4mLRC6pknv1wds3IXKRzFn9e8JeMdBOIXgCXzr8ugTx4ReYLTVvBckTpjsqHomJYw/hMJnFBpU9LnYnrcy8oVNcfmtoiS6ROYDHrI4JR1WAvyylOr4LRRKNkGl93DwJoOd92n2P3oQxKgAaKXYNrTjQUkW9vpC/oG3Hs6mRx5t6qvKvOwaJSMe3a1rD+pZ305yqatLtUCsVafbc71va3bE2JMSr+eTHcM9kXcFi3rk7xZlJbHJ8vid7TN1MpPkoOC9ZZiG+ixGOT3VJSbuqBURYbrHfLpxvlezwL+b+qtIDTO/wGj9eMZqhQnUlTFTlZvkXLPm3W6Rwz8zh8=

matrix:
  exclude:
    - os: osx
      env: OCAML_VERSION=4.02.1 OPAM_VERSION=1.1.1
    - os: osx
      env: OCAML_VERSION=4.01.0 OPAM_VERSION=1.2.0
    - os: osx
      env: OCAML_VERSION=4.01.0 OPAM_VERSION=1.1.1

addons:
  apt:
    packages:
    - libelf-dev
    - aspcud

install: bash -e resources/travis/install_deps.sh

script: bash -e .travis-ci.sh

before_deploy: bash -e resources/travis/zip_release.sh

deploy:
# upload releases to github, from both Mac and Linux
- provider: releases
  api_key:
    # facebook-github-bot-0
    secure: I1W8xlf8Ojxkc92n8Rb9AGX7kdCk0DeWEPd6PKRrGQO0FtyCkcvxNo+wp6ApQI7+NqkuFRVngHVOQOd3AqR57IFiSjZ+Cj/BJyg6WOo92olkAAP0OWihmCj53d2xDpp7LaM99srPbZXYE5vSTTKBX/5Soz9UghzsI5Q1ECmV5fU=
  repo: facebook/flow
  skip_cleanup: true
  file_glob: true
  file: flow-*.zip
  on:
    tags: true
    condition:
    - $OCAML_VERSION = 4.02.1
    - $OPAM_VERSION = 1.2.0

# Deploy the website
- provider: script
  repo: facebook/flow
  script: bash -e resources/travis/deploy.sh
  skip_cleanup: true
  on:
    all_branches: true
    condition:
    - $TRAVIS_TAG != "" || $TRAVIS_BRANCH = "master"
    - $TRAVIS_OS_NAME = linux
    - $OCAML_VERSION = 4.02.1
    - $OPAM_VERSION = 1.2.0

notifications:
  email:
    recipients:
      - flowtype@fb.com
  irc:
    channels:
      - "chat.freenode.net#flowtype"
    on_success: change
